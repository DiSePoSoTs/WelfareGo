<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings>
	<named-native-query name="interventi_per_proroga_automatica">
		<query><![CDATA[
        SELECT
            DISTINCT
            intervento.COD_PAI,
            intervento.COD_TIPINT,
            intervento.CNT_TIPINT
        FROM
            PAI_INTERVENTO intervento
            JOIN TIPOLOGIA_INTERVENTO tip_int
            ON intervento.COD_TIPINT = tip_int.COD_TIPINT
            JOIN pai pai
            ON intervento.cod_pai = pai.COD_PAI
            JOIN CARTELLA_SOCIALE cartella_soc
            ON cartella_soc.COD_ANA = pai.COD_ANA
            JOIN ANAGRAFE_SOC anagrafe_soc
            ON anagrafe_soc.COD_ANA = cartella_soc.cod_ana
        WHERE
            1=1
            AND tip_int.FLG_RINNOVO <> 'N'
            AND intervento.STATO_INT = 'E'
            AND intervento.RINNOVATO = 1
            AND anagrafe_soc.DT_MORTE IS NULL
            -- non so come fare questo and con le jpa, per cui uso sql diretto
            AND (
                CASE
                    WHEN tip_int.FLG_FINE_DURATA='F' AND intervento.DT_FINE BETWEEN ? AND ? THEN 1
                    WHEN tip_int.FLG_FINE_DURATA='D' AND ADD_MONTHS(intervento.DT_AVVIO, intervento.DUR_MESI) BETWEEN ? AND ?	THEN 1
                    ELSE 0
                end
            ) = 1
        ORDER BY

            intervento.COD_PAI ASC,
            intervento.COD_TIPINT ASC,
            intervento.CNT_TIPINT ASC
]]>
        </query>
	</named-native-query>

	<named-native-query
		name="interventi_aperti_da_chiudere">
		<query>
            <![CDATA[
             SELECT DISTINCT
                pi.COD_PAI codPai
                , pi.COD_TIPINT codTipint
                , pi.CNT_TIPINT cntTipint
             FROM
             PAI_INTERVENTO pi
             JOIN TIPOLOGIA_INTERVENTO tip_int
             ON tip_int.COD_TIPINT = pi.COD_TIPINT
             where
                1=1
                and STATO_INT = 'A'
                AND tip_int.FLG_RINNOVO_AUTO <> 'S'
                AND (
                    CASE
                    WHEN tip_int.FLG_FINE_DURATA='F' AND pi.DT_FINE < ? THEN 1
                    WHEN tip_int.FLG_FINE_DURATA='D' AND (ADD_MONTHS(DT_AVVIO, DUR_MESI) < ? ) THEN 1
                    ELSE 0
                    end
                ) = 1
             ORDER BY
             COD_PAI ASC,
             pi.COD_TIPINT ASC,
             CNT_TIPINT ASC
        ]]>
        </query>
	</named-native-query>
</entity-mappings>